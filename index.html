<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Mercato Buoni Mensa</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f2f2f2; margin: 0; padding: 20px; }
    h1 { text-align: center; margin-bottom: 30px; }
    #charts-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 40px; margin-bottom: 40px; }
    canvas { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); max-width: 500px; }
  </style>
</head>
<body>

<h1>ðŸ“ˆ Mercato Buoni Mensa</h1>

<div id="charts-container">
  <canvas id="salesChart" width="500" height="300"></canvas>
  <canvas id="demandChart" width="500" height="300"></canvas>
</div>

<script>
  // FIREBASE CONFIGURA QUI
  const firebaseConfig = {
    apiKey: "AIzaSyDmYmIt5jDXMug_OXH0xPP2vyLsy02Alk4",
    authDomain: "mensa-ea014.firebaseapp.com",
    projectId: "mensa-ea014",
    storageBucket: "mensa-ea014.appspot.com",
    messagingSenderId: "341027510429",
    appId: "1:341027510429:web:3d51e97b08ee7d251a9c74",
    measurementId: "G-9B5YYE6CK2"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const salesChart = new Chart(document.getElementById("salesChart"), {
    type: 'line',
    data: {
      datasets: [{
        label: "Prezzo medio vendita (â‚¬ per buono)",
        borderColor: "green",
        backgroundColor: "rgba(0,128,0,0.1)",
        data: [],
        fill: true,
        tension: 0.2,
        pointRadius: 5,
        pointHoverRadius: 7,
      }]
    },
    options: {
      responsive: true,
      scales: {
        x: {
          type: 'time',
          time: {
            unit: 'day',
            tooltipFormat: 'dd/MM/yyyy HH:mm',
            displayFormats: { day: 'dd/MM/yyyy' }
          },
          title: { display: true, text: 'Data' },
          ticks: { maxRotation: 0, autoSkipPadding: 15 }
        },
        y: {
          beginAtZero: true,
          title: { display: true, text: 'Prezzo (â‚¬ per buono)' }
        }
      },
      plugins: { legend: { display: true } }
    }
  });

  const demandChart = new Chart(document.getElementById("demandChart"), {
    type: 'line',
    data: {
      datasets: [{
        label: "Prezzo medio richiesta (â‚¬ per buono)",
        borderColor: "red",
        backgroundColor: "rgba(255,0,0,0.1)",
        data: [],
        fill: true,
        tension: 0.2,
        pointRadius: 5,
        pointHoverRadius: 7,
      }]
    },
    options: {
      responsive: true,
      scales: {
        x: {
          type: 'time',
          time: {
            unit: 'day',
            tooltipFormat: 'dd/MM/yyyy HH:mm',
            displayFormats: { day: 'dd/MM/yyyy' }
          },
          title: { display: true, text: 'Data' },
          ticks: { maxRotation: 0, autoSkipPadding: 15 }
        },
        y: {
          beginAtZero: true,
          title: { display: true, text: 'Prezzo (â‚¬ per buono)' }
        }
      },
      plugins: { legend: { display: true } }
    }
  });

  async function loadData() {
    const snapshot = await db.collection("transactions").orderBy("timestamp").get();

    const sales = [];
    const demand = [];

    snapshot.forEach(doc => {
      const data = doc.data();
      const dateObj = data.timestamp.toDate ? data.timestamp.toDate() : new Date(data.timestamp);
      if (data.type === "vendita") sales.push({ x: dateObj, y: data.unitPrice });
      if (data.type === "richiesta") demand.push({ x: dateObj, y: data.unitPrice });
    });

    salesChart.data.datasets[0].data = sales;
    salesChart.update();

    demandChart.data.datasets[0].data = demand;
    demandChart.update();
  }

  loadData();
</script>

</body>
</html>
