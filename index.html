<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Domanda e Offerta Buoni Mensa</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      background: #fafafa;
      color: #333;
      padding: 10px 15px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 {
      margin-bottom: 0.3em;
      text-align: center;
      color: #007bff;
      user-select: none;
    }
    .charts-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 30px;
      max-width: 900px;
      width: 100%;
      margin-bottom: 40px;
    }
    .chart-box {
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-radius: 10px;
      padding: 15px 25px;
      flex: 1 1 400px;
      max-width: 450px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .chart-box h2 {
      margin-top: 0;
      margin-bottom: 10px;
      color: #333;
    }
    canvas {
      max-width: 100%;
      height: 320px !important;
    }
    table {
      width: 100%;
      max-width: 900px;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-radius: 10px;
      overflow: hidden;
    }
    th, td {
      padding: 12px 15px;
      border-bottom: 1px solid #ddd;
      text-align: center;
      font-size: 0.9rem;
    }
    th {
      background-color: #007bff;
      color: white;
      font-weight: 600;
      user-select: none;
    }
    tr:last-child td {
      border-bottom: none;
    }
    @media (max-width: 600px) {
      .charts-container {
        flex-direction: column;
        gap: 20px;
      }
      .chart-box {
        max-width: 100%;
      }
      table, th, td {
        font-size: 0.8rem;
      }
    }
  </style>
</head>
<body>

  <h1>Domanda e Offerta Buoni Mensa</h1>

  <div class="charts-container">
    <div class="chart-box">
      <h2>Domanda</h2>
      <canvas id="chartRichiesta"></canvas>
    </div>
    <div class="chart-box">
      <h2>Offerta</h2>
      <canvas id="chartVendita"></canvas>
    </div>
  </div>

  <table id="summaryTable">
    <thead>
      <tr>
        <th>Data</th>
        <th>Domanda (buoni)</th>
        <th>Offerta (buoni)</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="3">Caricamento dati...</td></tr>
    </tbody>
  </table>

<script>
  // Configura Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyDmYmIt5jDXMug_OXH0xPP2vyLsy02Alk4",
    authDomain: "mensa-ea014.firebaseapp.com",
    projectId: "mensa-ea014",
    storageBucket: "mensa-ea014.appspot.com",
    messagingSenderId: "341027510429",
    appId: "1:341027510429:web:3d51e97b08ee7d251a9c74",
    measurementId: "G-9B5YYE6CK2"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Funzione per raggruppare dati per giorno e tipo (vendita o richiesta)
  function groupByDayAndType(data) {
    const map = new Map();
    data.forEach(d => {
      const date = d.timestamp.toDate ? d.timestamp.toDate() : new Date(d.timestamp);
      // Prendi solo data senza orario (yyyy-mm-dd)
      const day = date.toISOString().split('T')[0];

      if (!map.has(day)) map.set(day, { vendita: 0, richiesta: 0 });
      const entry = map.get(day);
      entry[d.type] += d.quantity * 10; // blocchetti * 10 buoni
    });
    return map;
  }

  // Setup ChartJS per grafici belli
  let chartRichiesta, chartVendita;

  function createChart(ctx, label, color) {
    return new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: label,
          data: [],
          borderColor: color,
          backgroundColor: color + "55",
          fill: true,
          tension: 0.25,
          pointRadius: 4,
          pointHoverRadius: 6,
          borderWidth: 3,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            type: 'time',
            time: {
              unit: 'day',
              tooltipFormat: 'dd/MM/yyyy',
              displayFormats: {
                day: 'dd/MM'
              }
            },
            grid: {
              color: '#eee'
            }
          },
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Numero buoni'
            },
            grid: {
              color: '#eee'
            }
          }
        },
        plugins: {
          legend: {
            display: true,
            labels: { font: { size: 14 } }
          },
          tooltip: {
            mode: 'index',
            intersect: false,
          }
        },
        interaction: {
          mode: 'nearest',
          axis: 'x',
          intersect: false
        }
      }
    });
  }

  async function loadData() {
    const snapshot = await db.collection("transactions").orderBy("timestamp", "asc").get();
    const docs = snapshot.docs.map(doc => doc.data());

    const grouped = groupByDayAndType(docs);

    // Ordina le date
    const dates = Array.from(grouped.keys()).sort();

    // Prepara i dati per i grafici
    const datiDomanda = [];
    const datiOfferta = [];

    dates.forEach(day => {
      const entry = grouped.get(day);
      datiDomanda.push({ x: day, y: entry.richiesta || 0 });
      datiOfferta.push({ x: day, y: entry.vendita || 0 });
    });

    // Crea o aggiorna i grafici
    if (!chartRichiesta) {
      chartRichiesta = createChart(document.getElementById('chartRichiesta').getContext('2d'), 'Domanda', '#007bff');
      chartVendita = createChart(document.getElementById('chartVendita').getContext('2d'), 'Offerta', '#28a745');
    }
    chartRichiesta.data.labels = dates;
    chartRichiesta.data.datasets[0].data = datiDomanda;
    chartRichiesta.update();

    chartVendita.data.labels = dates;
    chartVendita.data.datasets[0].data = datiOfferta;
    chartVendita.update();

    // Aggiorna la tabella riassuntiva
    const tbody = document.querySelector("#summaryTable tbody");
    tbody.innerHTML = "";
    if (dates.length === 0) {
      tbody.innerHTML = `<tr><td colspan="3">Nessun dato disponibile</td></tr>`;
      return;
    }
    dates.forEach(day => {
      const e = grouped.get(day);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${day.split('-').reverse().join('/')}</td>
        <td>${e.richiesta || 0}</td>
        <td>${e.vendita || 0}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  loadData();
</script>

</body>
</html>

