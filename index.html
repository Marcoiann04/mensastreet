<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Andamento Buoni Mensa</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: auto;
      padding: 20px;
      background: #f4f6f8;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    #loginSection, #inputSection {
      max-width: 500px;
      margin: 20px auto;
      padding: 15px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 0 10px #ccc;
    }
    #inputSection {
      display: none;
    }
    label {
      display: block;
      margin: 10px 0 5px;
    }
    input[type="number"], input[type="text"], input[type="password"] {
      width: 100%;
      padding: 7px;
      box-sizing: border-box;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    button {
      margin-top: 15px;
      padding: 10px 15px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
    }
    button:disabled {
      background-color: #888;
      cursor: not-allowed;
    }
    #charts {
      display: flex;
      justify-content: space-between;
      gap: 20px;
      margin-top: 40px;
      flex-wrap: wrap;
    }
    canvas {
      background: white;
      border-radius: 8px;
      box-shadow: 0 0 10px #ccc;
      max-width: 100%;
      height: 300px !important;
      flex: 1 1 45%;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      padding: 8px;
      border-bottom: 1px solid #ddd;
      text-align: center;
    }
    tr:hover {
      background-color: #f1f1f1;
    }
    .actions button {
      background: #e74c3c;
      margin: 0 3px;
      font-size: 14px;
      padding: 5px 8px;
    }
  </style>
</head>
<body>
  <h1>Andamento Buoni Mensa</h1>

  <div id="charts">
    <canvas id="chartVendita"></canvas>
    <canvas id="chartRichiesta"></canvas>
  </div>

  <div id="loginSection">
    <h2>Area riservata - Login</h2>
    <input type="password" id="passwordInput" placeholder="Inserisci password" />
    <button id="loginBtn">Accedi</button>
    <p id="loginError" style="color:red; display:none;">Password errata</p>
  </div>

  <div id="inputSection">
    <h2>Inserisci o modifica dati</h2>
    <label for="tipoSelect">Tipo</label>
    <select id="tipoSelect">
      <option value="vendita">Vendita</option>
      <option value="richiesta">Richiesta</option>
    </select>

    <label for="blocchettiInput">Numero blocchetti (1 blocchetto = 10 buoni)</label>
    <input type="number" id="blocchettiInput" min="1" value="1" />

    <label for="prezzoInput">Prezzo</label>
    <input type="number" id="prezzoInput" min="1" step="0.01" />

    <label>
      <input type="checkbox" id="parzialeCheckbox" />
      Prezzo parziale (prezzo per blocchetto)
    </label>

    <button id="saveBtn">Salva</button>
    <button id="logoutBtn" style="background:#888; margin-left: 15px;">Esci</button>

    <h3>Dati inseriti</h3>
    <table id="dataTable">
      <thead>
        <tr><th>Tipo</th><th>Blocchetti</th><th>Prezzo totale (‚Ç¨)</th><th>Prezzo parz. (‚Ç¨)</th><th>Data/Ora</th><th>Azioni</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
  // Configura Firebase con la tua config
  const firebaseConfig = {
 apiKey: "AIzaSyDmYmIt5jDXMug_OXH0xPP2vyLsy02Alk4",
  authDomain: "mensa-ea014.firebaseapp.com",
  projectId: "mensa-ea014",
  storageBucket: "mensa-ea014.firebasestorage.app",
  messagingSenderId: "341027510429",
  appId: "1:341027510429:web:3d51e97b08ee7d251a9c74",
  measurementId: "G-9B5YYE6CK2"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Elementi DOM
  const loginSection = document.getElementById('loginSection');
  const inputSection = document.getElementById('inputSection');
  const passwordInput = document.getElementById('passwordInput');
  const loginBtn = document.getElementById('loginBtn');
  const loginError = document.getElementById('loginError');
  const logoutBtn = document.getElementById('logoutBtn');
  const saveBtn = document.getElementById('saveBtn');
  const tipoSelect = document.getElementById('tipoSelect');
  const blocchettiInput = document.getElementById('blocchettiInput');
  const prezzoInput = document.getElementById('prezzoInput');
  const parzialeCheckbox = document.getElementById('parzialeCheckbox');
  const dataTableBody = document.querySelector('#dataTable tbody');

  const PASSWORD = "ciao";

  let currentUserLoggedIn = false;
  let editId = null;

  // Chart.js setup
  let chartVendita, chartRichiesta;

  function createChart(ctx, label, color) {
    return new Chart(ctx, {
      type: 'line',
      data: {
        datasets: [{
          label: label,
          data: [],
          borderColor: color,
          backgroundColor: color + '88',
          fill: false,
          tension: 0.3,
          pointRadius: 5,
          pointHoverRadius: 7,
          borderWidth: 3,
          cubicInterpolationMode: 'monotone',
        }]
      },
      options: {
        responsive: true,
        scales: {
          x: {
            type: 'time',
            time: {
              unit: 'hour',
              displayFormats: {
                hour: 'MMM dd',
              }
            },
            title: { display: true, text: 'Data' },
            ticks: {
              autoSkip: true,
              maxTicksLimit: 10,
            }
          },
          y: {
            title: { display: true, text: 'Prezzo medio ‚Ç¨' },
            beginAtZero: false
          }
        },
        plugins: {
          legend: { display: true }
        }
      }
    });
  }

  function updateCharts(data) {
    // Filtra dati per tipo
    const vendite = data.filter(d => d.tipo === 'vendita');
    const richieste = data.filter(d => d.tipo === 'richiesta');

    // Funzione per calcolare prezzo medio per ogni punto
    function calcDataPoints(arr) {
      return arr.map(item => {
        return {
          x: item.timestamp.toDate(),
          y: (item.parziale ? item.prezzo * item.blocchetti : item.prezzo) / (item.blocchetti * 10)
        };
      });
    }

    const venditeData = calcDataPoints(vendite);
    const richiesteData = calcDataPoints(richieste);

    chartVendita.data.datasets[0].data = venditeData;
    chartRichiesta.data.datasets[0].data = richiesteData;

    chartVendita.update();
    chartRichiesta.update();
  }

  function loadData() {
    db.collection("transactions")
      .orderBy("timestamp", "asc")
      .onSnapshot(snapshot => {
        let data = [];
        snapshot.forEach(doc => {
          data.push({ id: doc.id, ...doc.data() });
        });
        updateCharts(data);
        renderTable(data);
      });
  }

  function renderTable(data) {
    dataTableBody.innerHTML = "";
    data.forEach(item => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${item.tipo}</td>
        <td>${item.blocchetti}</td>
        <td>${item.parziale ? (item.prezzo * item.blocchetti).toFixed(2) : item.prezzo.toFixed(2)}</td>
        <td>${item.parziale ? item.prezzo.toFixed(2) : '-'}</td>
        <td>${item.timestamp.toDate().toLocaleString()}</td>
        <td class="actions">
          <button data-id="${item.id}" class="editBtn">‚úèÔ∏è</button>
          <button data-id="${item.id}" class="deleteBtn">üóëÔ∏è</button>
        </td>
      `;
      dataTableBody.appendChild(tr);
    });

    // Eventi edit e delete
    document.querySelectorAll('.editBtn').forEach(btn => {
      btn.onclick = e => {
        const id = e.target.dataset.id;
        editItem(id);
      };
    });

    document.querySelectorAll('.deleteBtn').forEach(btn => {
      btn.onclick = e => {
        const id = e.target.dataset.id;
        if (confirm("Sei sicuro di voler eliminare questo dato?")) {
          db.collection("transactions").doc(id).delete();
        }
      };
    });
  }

  function editItem(id) {
    db.collection("transactions").doc(id).get().then(doc => {
      if (!doc.exists) return alert("Dato non trovato");
      const d = doc.data();
      editId = id;
      tipoSelect.value = d.tipo;
      blocchettiInput.value = d.blocchetti;
      prezzoInput.value = d.parziale ? d.prezzo : (d.prezzo / d.blocchetti);
      parzialeCheckbox.checked = d.parziale;
      // Mostra inputSection se nascosto
      if (!currentUserLoggedIn) {
        alert("Devi fare il login per modificare");
        return;
      }
      inputSection.style.display = 'block';
      loginSection.style.display = 'none';
    });
  }

  loginBtn.onclick = () => {
    if (passwordInput.value === PASSWORD) {
      currentUserLoggedIn = true;
      loginSection.style.display = 'none';
      inputSection.style.display = 'block';
      loginError.style.display = 'none';
    } else {
      loginError.style.display = 'block';
    }
    passwordInput.value = '';
  };

  logoutBtn.onclick = () => {
    currentUserLoggedIn = false;
    inputSection.style.display = 'none';
    loginSection.style.display = 'block';
  };

  saveBtn.onclick = () => {
    const tipo = tipoSelect.value;
    const blocchetti = Number(blocchettiInput.value);
    let prezzo = Number(prezzoInput.value);
    const parziale = parzialeCheckbox.checked;

    if (!tipo || blocchetti < 1 || prezzo <= 0) {
      alert("Inserisci dati validi");
      return;
    }

    // Se prezzo totale, prezzo da salvare √® il totale; se parziale, il prezzo √® per blocchetto
    if (!parziale) {
      prezzo = prezzo; // prezzo totale
    } else {
      prezzo = prezzo; // prezzo parziale per blocchetto
    }

    const docData = {
      tipo,
      blocchetti,
      prezzo,
      parziale,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };

    if (editId) {
      db.collection("transactions").doc(editId).update(docData).then(() => {
        editId = null;
        resetForm();
      });
    } else {
      db.collection("transactions").add(docData).then(() => {
        resetForm();
      });
    }
  };

  function resetForm() {
    tipoSelect.value = 'vendita';
    blocchettiInput.value = 1;
    prezzoInput.value = '';
    parzialeCheckbox.checked = false;
  }

  // Inizializza i grafici
  window.onload = () => {
    const ctxVendita = document.getElementById('chartVendita').getContext('2d');
    const ctxRichiesta = document.getElementById('chartRichiesta').getContext('2d');

    chartVendita = createChart(ctxVendita, 'Vendita', 'rgba(75, 192, 192, 1)');
    chartRichiesta = createChart(ctxRichiesta, 'Richiesta', 'rgba(255, 99, 132, 1)');
loadData();};
</script>

</body> </html>



