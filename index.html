


<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Mercato Buoni Mensa</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f2f2f2; margin: 0; padding: 20px; }
    h1 { text-align: center; }
    #charts-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 40px; }
    canvas { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    #admin { max-width: 600px; margin: 40px auto; display: none; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    label, input, select { display: block; margin: 10px 0; width: 100%; }
    input[type="password"] { width: 200px; }
    button { margin-top: 10px; padding: 10px; cursor: pointer; }
    #login { text-align: center; margin-top: 40px; }
    table { width: 100%; margin-top: 20px; border-collapse: collapse; }
    th, td { border: 1px solid #ddd; padding: 8px; }
  </style>
</head>
<body>

<h1>ðŸ“ˆ Mercato Buoni Mensa</h1>
<div id="charts-container">
  <canvas id="salesChart" width="400" height="250"></canvas>
  <canvas id="demandChart" width="400" height="250"></canvas>
</div>

<div id="login">
  <input type="password" id="passwordInput" placeholder="Password">
  <button onclick="checkPassword()">Accedi area riservata</button>
</div>

<div id="admin">
  <h2>Gestione Transazioni</h2>
  <label>Tipo:
    <select id="type">
      <option value="vendita">Vendita</option>
      <option value="richiesta">Richiesta</option>
    </select>
  </label>
  <label>QuantitÃ  blocchetti: <input type="number" id="quantity"></label>
  <label>Prezzo: <input type="number" id="price"></label>
  <label>Tipo prezzo:
    <select id="priceType">
      <option value="totale">Totale</option>
      <option value="parziale">Parziale</option>
    </select>
  </label>
  <button onclick="addTransaction()">Inserisci</button>
  <table id="transactionTable"></table>
</div>

<script>
  // ðŸ”§ CONFIGURAZIONE FIREBASE - SOSTITUISCI QUI
  const firebaseConfig = {
 apiKey: "AIzaSyDmYmIt5jDXMug_OXH0xPP2vyLsy02Alk4",
  authDomain: "mensa-ea014.firebaseapp.com",
  projectId: "mensa-ea014",
  storageBucket: "mensa-ea014.firebasestorage.app",
  messagingSenderId: "341027510429",
  appId: "1:341027510429:web:3d51e97b08ee7d251a9c74",
  measurementId: "G-9B5YYE6CK2"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const password = "ciao";
  function checkPassword() {
    const input = document.getElementById("passwordInput").value;
    if (input === password) {
      document.getElementById("admin").style.display = "block";
      document.getElementById("login").style.display = "none";
      loadTable();
    } else {
      alert("Password errata");
    }
  }

  async function addTransaction() {
    const type = document.getElementById("type").value;
    const quantity = parseInt(document.getElementById("quantity").value);
    const price = parseFloat(document.getElementById("price").value);
    const priceType = document.getElementById("priceType").value;

    if (!quantity || !price) return alert("Inserisci tutti i campi");

    let unitPrice;
    if (priceType === "totale") {
      unitPrice = (price / quantity) / 10; // 1 blocchetto = 10 buoni
    } else {
      unitPrice = price / 10; // parziale per blocchetto
    }

    await db.collection("transactions").add({
      type,
      quantity,
      totalPrice: price,
      unitPrice: parseFloat(unitPrice.toFixed(2)),
      timestamp: new Date()
    });

    loadData();
    loadTable();
  }

  async function loadData() {
    const snapshot = await db.collection("transactions").orderBy("timestamp").get();
    const sales = [];
    const demand = [];
    const labels = [];

    snapshot.forEach(doc => {
      const data = doc.data();
     const date = new Date(data.timestamp.seconds * 1000).toISOString().split('T')[0];

      if (!labels.includes(date)) labels.push(date);
      if (data.type === "vendita") sales.push({ x: date, y: data.unitPrice });
      if (data.type === "richiesta") demand.push({ x: date, y: data.unitPrice });
    });

    salesChart.data.labels = labels;
    salesChart.data.datasets[0].data = sales;
    salesChart.update();

    demandChart.data.labels = labels;
    demandChart.data.datasets[0].data = demand;
    demandChart.update();
  }

  async function loadTable() {
    const table = document.getElementById("transactionTable");
    table.innerHTML = "<tr><th>Tipo</th><th>Q.tÃ </th><th>Prezzo</th><th>Azioni</th></tr>";
    const snapshot = await db.collection("transactions").orderBy("timestamp").get();
    snapshot.forEach(doc => {
      const d = doc.data();
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${d.type}</td>
        <td>${d.quantity}</td>
        <td>â‚¬ ${d.totalPrice}</td>
        <td><button onclick="deleteTransaction('${doc.id}')">Elimina</button></td>`;
      table.appendChild(row);
    });
  }

  async function deleteTransaction(id) {
    await db.collection("transactions").doc(id).delete();
    loadData();
    loadTable();
  }

  // ChartJS
  const salesChart = new Chart(document.getElementById("salesChart"), {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label: "Prezzo medio vendita (â‚¬ per buono)",
        borderColor: "green",
        data: [],
        fill: false,
        tension: 0.1
      }]
    }
  });

  const demandChart = new Chart(document.getElementById("demandChart"), {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label: "Prezzo medio richiesta (â‚¬ per buono)",
        borderColor: "red",
        data: [],
        fill: false,
        tension: 0.1
      }]
    }
  });

  loadData();
</script>

</body>
</html>
